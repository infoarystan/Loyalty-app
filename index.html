<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 20px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; }
        .balance { font-size: 42px; font-weight: bold; color: #34C759; margin: 10px 0; }
        #qrcode { margin: 20px auto; background: white; padding: 10px; border-radius: 10px; display: inline-block; }
        #timer { font-size: 12px; opacity: 0.5; margin-top: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞ */
        .staff-btn { margin-top: 30px; padding: 10px 20px; background: transparent; border: 1px solid var(--tg-theme-hint-color, #999); color: var(--tg-theme-hint-color, #999); border-radius: 8px; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card" id="user-view">
        <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div>–í–∞—à–∏ –±–∞–ª–ª—ã:</div>
        <div class="balance" id="balance">...</div>
        
        <div id="qrcode"></div>
        <div id="timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫</div>
        
        <button class="staff-btn" onclick="switchMode()">–Ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ üëÆ‚Äç‚ôÇÔ∏è</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –±—É–¥–µ—Ç –≤ n8n)
        const SECRET_KEY = "MY_SUPER_SECRET_KEY"; 

        // 1. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if (user) document.getElementById('username').innerText = user.first_name;
        
        // –ß–∏—Ç–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Å—Å—ã–ª–∫–∏
        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById('balance').innerText = urlParams.get('balance') || "0";

        // 2. –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û QR (–ì–ª–∞–≤–∞ 8.1)
        function generateSecureQR() {
            const userId = user ? user.id.toString() : "DEMO";
            const timestamp = Math.floor(Date.now() / 1000); // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å—å: UserID + –í—Ä–µ–º—è + –°–µ–∫—Ä–µ—Ç
            const dataToSign = userId + timestamp;
            const hash = CryptoJS.HmacSHA256(dataToSign, SECRET_KEY).toString(CryptoJS.enc.Hex);
            
            // –§–æ—Ä–º–∞—Ç JSON –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞: u=user, t=time, s=signature
            const qrData = JSON.stringify({
                u: userId,
                t: timestamp,
                s: hash.substring(0, 10) // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ —Ö–µ—à–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
            });

            // –†–∏—Å—É–µ–º QR
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: qrData,
                width: 180, height: 180
            });
            
            console.log("QR –æ–±–Ω–æ–≤–ª–µ–Ω", timestamp);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É –∏ –ø–æ—Ç–æ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        generateSecureQR();
        setInterval(generateSecureQR, 30000); // 30000 –º—Å = 30 —Å–µ–∫

        // 3. –†–ï–ñ–ò–ú –ö–ê–°–°–ò–†–ê (–ì–ª–∞–≤–∞ 8.2)
        function switchMode() {
            // –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫–∞–Ω–µ—Ä –¢–µ–ª–µ–≥—Ä–∞–º–∞
            tg.showScanQrPopup({
                text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞'
            }, (data) => {
                // –ö–æ–≥–¥–∞ —Å–∫–∞–Ω–µ—Ä —á—Ç–æ-—Ç–æ —É–≤–∏–¥–µ–ª:
                // data - —ç—Ç–æ —Ç–µ–∫—Å—Ç –∏–∑ QR –∫–æ–¥–∞ (–Ω–∞—à JSON)
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä (true)
                tg.closeScanQrPopup();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–≤ n8n)
                // –ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ –∫–∞–∫ "—Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" –æ—Ç –∏–º–µ–Ω–∏ –∫–∞—Å—Å–∏—Ä–∞
                tg.sendData(data); 
            });
        }

    </script>
</body>
</html>