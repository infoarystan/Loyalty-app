<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Loyalty App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
    body { 
        font-family: -apple-system, sans-serif; 
        background: #f4f4f9; 
        margin: 0; 
        height: 100vh; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    #staff-view, #client-view { 
        display: none; 
        text-align: center; 
        width: 90%; 
        max-width: 360px; 
    }
    .staff-btn { 
        width: 220px; 
        height: 220px; 
        border-radius: 50%; 
        background: #007AFF; 
        color: #fff; 
        border: none; 
        font-size: 20px; 
        font-weight: bold; 
        box-shadow: 0 8px 20px rgba(0,122,255,0.3); 
        cursor: pointer;
    }
    .staff-btn:active {
        transform: scale(0.98);
    }
    .card { 
        background: #fff; 
        padding: 25px; 
        border-radius: 20px; 
        box-shadow: 0 6px 20px rgba(0,0,0,.1); 
    }
    .balance { 
        font-size: 52px; 
        font-weight: bold; 
        color: #28a745; 
    }
    #qrcode { 
        margin: 20px 0; 
        display: flex;
        justify-content: center;
    }
    #qrcode img {
        border: 8px solid white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #timer { 
        color: #888; 
        font-size: 14px; 
        margin-top: 10px;
    }
</style>
</head>
<body>

<div id="staff-view">
    <button class="staff-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
    <p style="opacity:.6">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
    <p id="scan-error" style="color: red; display: none; font-size: 14px; margin-top: 10px;">
        –°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
    </p>
</div>

<div id="client-view" class="card">
    <h2 id="username">–ì–æ—Å—Ç—å</h2>
    <div class="balance" id="balance">0</div>
    <div id="qrcode"></div>
    <div id="timer">–ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;
const SECRET_KEY = "SECRET"; 
const STAFF_IDS = [627287121]; 
const QR_TTL = 60;

if (!user) {
    document.body.innerHTML = '<h3 style="padding:20px;text-align:center">–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram</h3>';
} else {
    initApp();
}

function initApp() {
    const balance = tg.initDataUnsafe?.start_param || "0";
    document.getElementById("balance").innerText = balance;

    if (STAFF_IDS.includes(user.id)) {
        document.getElementById("staff-view").style.display = "block";
    } else {
        document.getElementById("client-view").style.display = "block";
        document.getElementById("username").innerText = user.first_name;
        startQR();
    }
}

function openScanner() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∫–∞–Ω–µ—Ä–∞
    if (typeof tg.showScanQrPopup !== 'function') {
        document.getElementById('scan-error').style.display = 'block';
        alert('–°–∫–∞–Ω–µ—Ä QR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ Telegram');
        return;
    }
    
    const scanConfig = {
        text: "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞"
    };
    
    tg.showScanQrPopup(scanConfig, (scannedData) => {
        if (!scannedData) {
            console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å');
            return;
        }
        
        console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', scannedData);
        
        try {
            // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ QR
            const data = JSON.parse(scannedData);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç
            tg.sendData(JSON.stringify({
                type: 'scan_result',
                data: data,
                timestamp: Date.now(),
                scannerId: user.id
            }));
            
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            tg.showAlert('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR:', error);
            tg.showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR-–∫–æ–¥–∞');
        }
    });
}

function startQR() {
    let timeLeft = QR_TTL;
    let qrCodeInstance = null;

    function generateQR() {
        const ts = Math.floor(Date.now() / 1000);
        const nonce = Math.random().toString(36).substring(2, 10);
        const sign = CryptoJS.HmacSHA256(
            user.id + ts + nonce, 
            SECRET_KEY
        ).toString(CryptoJS.enc.Hex).substring(0, 12);

        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π payload
        const payload = JSON.stringify({
            uid: user.id,
            ts: ts,
            n: nonce,
            s: sign
        });

        const qrDiv = document.getElementById("qrcode");
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR
        qrDiv.innerHTML = "";
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π QR —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        qrCodeInstance = new QRCode(qrDiv, {
            text: payload,
            width: 220,
            height: 220,
            correctLevel: QRCode.CorrectLevel.M,
            colorDark: "#000000",
            colorLight: "#ffffff",
            useSVG: false
        });
        
        timeLeft = QR_TTL;
        
        console.log('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω QR —Å –¥–∞–Ω–Ω—ã–º–∏:', payload);
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ä–∞–∑—É –∏ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
    generateQR();
    
    const qrInterval = setInterval(generateQR, QR_TTL * 1000);
    
    const timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft >= 0) {
            document.getElementById("timer").innerText = 
                –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
        }
    }, 1000);
    
    // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    window.addEventListener('beforeunload', () => {
        clearInterval(qrInterval);
        clearInterval(timerInterval);
    });
}
</script>
</body>
</html>