<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .staff-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
        }

        .user-name {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .balance-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .balance-amount {
            font-size: 56px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        .qr-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 16px;
            margin: 25px 0;
            display: inline-block;
            border: 2px solid #e9ecef;
        }

        .timer {
            font-size: 14px;
            color: #666;
            margin-top: 15px;
            font-weight: 500;
        }

        .staff-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .staff-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.6);
        }

        .staff-label {
            margin-top: 20px;
            color: white;
            font-size: 16px;
            opacity: 0.9;
            font-weight: 500;
        }

        .loading {
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: #dc3545;
        }

        .points-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .info-text {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            .card, .staff-card {
                padding: 20px;
                margin: 10px;
            }
            
            .balance-amount {
                font-size: 48px;
            }
            
            .staff-btn {
                width: 180px;
                height: 180px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading" class="loading">
            <div class="loader"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏...</div>
        </div>

        <!-- –†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="staff-view" class="staff-card" style="display: none;">
            <div class="emoji">üë®‚Äçüíº</div>
            <h2 style="margin-bottom: 30px; color: #333;">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            
            <button class="staff-btn" id="scan-btn" onclick="openScanner()">
                üì∑<br>
                <span style="font-size: 18px;">–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</span><br>
                <span style="font-size: 14px; opacity: 0.9;">QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</span>
            </button>
            
            <div class="staff-label">
                ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: <span id="staff-id">-</span>
            </div>
            
            <div id="scan-result" style="margin-top: 30px; display: none;">
                <div class="points-badge" id="scan-user">–ö–ª–∏–µ–Ω—Ç</div>
                <div id="scan-balance" style="margin-top: 15px;"></div>
            </div>
            
            <div class="info-text">
                –î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞
            </div>
        </div>

        <!-- –†–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="client-view" class="card" style="display: none;">
            <div class="emoji">üë§</div>
            <div class="user-name" id="user-name">–ì–æ—Å—Ç—å</div>
            
            <div class="balance-title">–í–∞—à –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤</div>
            <div class="balance-amount" id="balance">0</div>
            
            <div class="balance-title">–í–∞—à QR-–∫–æ–¥ –¥–ª—è –ø–æ–∫—É–ø–æ–∫</div>
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <div class="timer" id="timer">QR-–∫–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥</div>
            
            <div class="info-text">
                <strong>üì± –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong><br>
                1. –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –∫–∞—Å—Å–∏—Ä—É<br>
                2. –ö–∞—Å—Å–∏—Ä –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–¥<br>
                3. –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
                ‚ö°Ô∏è –ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
            </div>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="error-view" class="error" style="display: none;">
            <div class="emoji">‚ö†Ô∏è</div>
            <h3 style="margin-bottom: 15px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç</p>
            <button onclick="location.reload()" 
                    style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer;">
                –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            </button>
        </div>

        <!-- –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) -->
        <div id="test-view" class="card" style="display: none;">
            <div class="emoji">üîß</div>
            <h2 style="margin-bottom: 20px; color: #333;">–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º</h2>
            <p style="margin-bottom: 20px; color: #666;">Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –í–∫–ª—é—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º.</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                <button onclick="switchToClient()" 
                        style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer;">
                    üë§ –†–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
                </button>
                <button onclick="switchToStaff()" 
                        style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer;">
                    üë®‚Äçüíº –†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                </button>
            </div>
            
            <div class="info-text">
                <strong>–î–ª—è —Ä–∞–±–æ—Ç—ã –≤ Telegram:</strong><br>
                1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather<br>
                2. –î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±–æ—Ç–∞<br>
                3. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
            </div>
        </div>
    </div>

    <div class="version">v1.0.2</div>

    <script>
        // ============= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ö–û–ù–°–¢–ê–ù–¢–´ =============
        const STAFF_IDS = [627287121]; // ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
        const SECRET_KEY = "loyalty-secret-2024"; // –ö–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ QR
        const QR_TTL = 60; // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ QR –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        let tg = null;
        let currentUser = null;
        let qrCodeInstance = null;
        let qrTimer = null;
        let countdownTimer = null;

        // ============= –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò =============
        function initApp() {
            console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===');
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å Telegram Web App
                tg = window.Telegram?.WebApp;
                
                if (!tg) {
                    console.log('Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–∫–ª—é—á–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
                    showTestView();
                    return;
                }
                
                console.log('Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –≤–µ—Ä—Å–∏—è:', tg.version);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                tg.ready();
                
                // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                tg.expand();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser = tg.initDataUnsafe?.user;
                
                if (!currentUser) {
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã');
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞
                const balance = tg.initDataUnsafe?.start_param || "150";
                
                // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                hideLoading();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
                if (STAFF_IDS.includes(parseInt(currentUser.id))) {
                    console.log('–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ä–µ–∂–∏–º –°–û–¢–†–£–î–ù–ò–ö–ê');
                    showStaffMode(currentUser, balance);
                } else {
                    console.log('–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ä–µ–∂–∏–º –ö–õ–ò–ï–ù–¢–ê');
                    showClientMode(currentUser, balance);
                }
                
            } catch (error) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + error.message);
            }
        }

        // ============= –†–ï–ñ–ò–ú –°–û–¢–†–£–î–ù–ò–ö–ê =============
        function showStaffMode(user, balance) {
            document.getElementById('staff-view').style.display = 'block';
            document.getElementById('staff-id').textContent = user.id;
        }

        // ============= –†–ï–ñ–ò–ú –ö–õ–ò–ï–ù–¢–ê =============
        function showClientMode(user, balance) {
            const clientView = document.getElementById('client-view');
            clientView.style.display = 'block';
            
            document.getElementById('user-name').textContent = user.first_name || '–ö–ª–∏–µ–Ω—Ç';
            document.getElementById('balance').textContent = balance;
            
            startQRGeneration(user.id, balance);
        }

        // ============= –ì–ï–ù–ï–†–ê–¶–ò–Ø QR-–ö–û–î–ê =============
        function startQRGeneration(userId, balance) {
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR-–∫–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            
            function generateQR() {
                const timestamp = Math.floor(Date.now() / 1000);
                const dataString = ${userId}:${timestamp}:${SECRET_KEY};
                
                // –ü—Ä–æ—Å—Ç–∞—è —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
                let hash = 0;
                for (let i = 0; i < dataString.length; i++) {
                    const char = dataString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                const signature = Math.abs(hash).toString(36).substring(0, 8);
                
                // –°–æ–∑–¥–∞–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (Telegram –ª—É—á—à–µ —á–∏—Ç–∞–µ—Ç URL)
                const qrData = https://loyalty.app/scan?uid=${userId}&t=${timestamp}&s=${signature}&b=${balance};
                
                console.log('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR —Å –¥–∞–Ω–Ω—ã–º–∏:', qrData);
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                
                try {
                    qrCodeInstance = new QRCode(qrContainer, {
                        text: qrData,
                        width: 180,
                        height: 180,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:', error);
                    qrContainer.innerHTML = '<div style="color: red; padding: 20px;">–û—à–∏–±–∫–∞ QR-–∫–æ–¥–∞</div>';
                }
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
            generateQR();
            
            // –¢–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è QR
            qrTimer = setInterval(generateQR, QR_TTL * 1000);
            
            // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
            let timeLeft = QR_TTL;
            updateTimerDisplay(timeLeft);
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    updateTimerDisplay(timeLeft);
                } else {
                    timeLeft = QR_TTL;
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = QR-–∫–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫;
            }
        }

        // ============= –°–ö–ê–ù–ï–† QR-–ö–û–î–ê (–î–õ–Ø –°–û–¢–†–£–î–ù–ò–ö–ê) =============
        function openScanner() {
            if (!tg || !tg.showScanQrPopup) {
                alert('–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ Telegram');
                return;
            }
            
            const scanConfig = {
                text: "–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞"
            };
            
            tg.showScanQrPopup(scanConfig, (scannedData) => {
                if (!scannedData) {
                    console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    return;
                }
                
                console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', scannedData);
                processScannedData(scannedData);
            });
        }

        function processScannedData(data) {
            try {
                let userId, timestamp, signature, balance;
                
                // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
                if (data.startsWith('http')) {
                    const url = new URL(data);
                    userId = url.searchParams.get('uid');
                    timestamp = url.searchParams.get('t');
                    signature = url.searchParams.get('s');
                    balance = url.searchParams.get('b');
                } else {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                    const jsonData = JSON.parse(data);
                    userId = jsonData.uid || jsonData.u;
                    timestamp = jsonData.t || jsonData.timestamp;
                    signature = jsonData.s || jsonData.sign;
                    balance = jsonData.b || jsonData.balance;
                }
                
                if (!userId) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const scanResult = document.getElementById('scan-result');
                const scanUser = document.getElementById('scan-user');
                const scanBalance = document.getElementById('scan-balance');
                
                scanUser.textContent = –ö–ª–∏–µ–Ω—Ç #${userId};
                scanBalance.innerHTML = `
                    <div style="color: #28a745; font-weight: bold; margin: 10px 0; font-size: 16px;">
                        –ë–∞–ª–∞–Ω—Å: ${balance || '0'} –±–∞–ª–ª–æ–≤
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="simulatePayment('${userId}', 500)" 
                                style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            –ß–µ–∫ 500‚ÇΩ
                        </button>
                        <button onclick="simulatePayment('${userId}', 1000)" 
                                style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            –ß–µ–∫ 1000‚ÇΩ
                        </button>
                    </div>
                `;
                
                scanResult.style.display = 'block';
                
                if (tg && tg.showAlert) {
                    tg.showAlert('‚úÖ QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!');
                } else {
                    alert('QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
        }

        // ============= –°–ò–ú–£–õ–Ø–¶–ò–Ø –û–ü–õ–ê–¢–´ (–î–õ–Ø –î–ï–ú–û) =============
        function simulatePayment(userId, amount) {
            const points = Math.floor(amount * 0.05); // 5% –∫–µ—à–±—ç–∫
            
            if (tg && tg.showAlert) {
                tg.showAlert(‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${points} –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–∫—É–ø–∫—É –Ω–∞ ${amount}‚ÇΩ);
            } else {
                alert(‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${points} –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–∫—É–ø–∫—É –Ω–∞ ${amount}‚ÇΩ);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('scan-result').style.display = 'none';
        }

        // ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ò–î–ò–ú–û–°–¢–¨–Æ –≠–ö–†–ê–ù–û–í =============
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            document.getElementById('error-view').style.display = 'block';
            if (message) {
                document.querySelector('#error-view p').textContent = message;
            }
        }

        function showTestView() {
            hideLoading();
            document.getElementById('test-view').style.display = 'block';
        }

        function switchToClient() {
            document.getElementById('test-view').style.display = 'none';
            showClientMode({ id: 123456, first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ö–ª–∏–µ–Ω—Ç' }, "250");
        }

        function switchToStaff() {
            document.getElementById('test-view').style.display = 'none';
            showStaffMode({ id: 627287121, first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –°–æ—Ç—Ä—É–¥–Ω–∏–∫' }, "0");
        }

        // ============= –û–ß–ò–°–¢–ö–ê –†–ï–°–£–†–°–û–í =============
        function cleanup() {
            if (qrTimer) clearInterval(qrTimer);
            if (countdownTimer) clearInterval(countdownTimer);
            console.log('–†–µ—Å—É—Ä—Å—ã –æ—á–∏—â–µ–Ω—ã');
        }

        // ============= –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =============
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É Telegram Web App
            setTimeout(initApp, 100);
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', cleanup);
        window.addEventListener('pagehide', cleanup);

        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.debugApp = {
            reload: () => location.reload(),
            showTest: showTestView,
            showClient: switchToClient,
            showStaff: switchToStaff,
            getState: () => ({
                tg: !!tg,
                user: currentUser,
                staffIds: STAFF_IDS
            })
        };
    </script>
</body>
</html>