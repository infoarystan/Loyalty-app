<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* –ö–õ–ò–ï–ù–¢–°–ö–ê–Ø –ß–ê–°–¢–¨ */
        #client-view { text-align: center; width: 85%; max-width: 320px; background: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */ }
        .balance { font-size: 48px; font-weight: 800; color: #34C759; margin: 15px 0; }
        #qrcode { margin: 20px auto; background: white; padding: 15px; border-radius: 15px; display: inline-block; }
        #timer { font-size: 14px; opacity: 0.6; margin-top: 10px; font-variant-numeric: tabular-nums; }

        /* –ö–ê–°–°–û–í–ê–Ø –ß–ê–°–¢–¨ */
        #staff-view { width: 100%; height: 100vh; display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */ flex-direction: column; align-items: center; justify-content: center; background-color: var(--tg-theme-bg-color, #fff); }
        .staff-btn {
            width: 250px;
            height: 250px;
            border-radius: 50%; /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ */
            background: linear-gradient(135deg, #007AFF, #0056b3);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,122,255,0.4);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .staff-btn:active { transform: scale(0.95); }
        .staff-icon { font-size: 60px; margin-bottom: 10px; }
        .staff-hint { margin-top: 30px; font-size: 14px; opacity: 0.5; text-align: center; max-width: 80%; }

    </style>
</head>
<body>

    <div class="container">
        
        <div id="client-view">
            <h2 id="username">–ì–æ—Å—Ç—å</h2>
            <div style="opacity: 0.7; font-size: 14px;">–í–∞—à–∏ –±–∞–ª–ª—ã:</div>
            <div class="balance" id="balance">0</div>
            
            <div id="qrcode"></div>
            <div id="timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>
        </div>

        <div id="staff-view">
            <button class="staff-btn" onclick="openScanner()">
                <div class="staff-icon">üì∑</div>
                –°–ö–ê–ù–ò–†–û–í–ê–¢–¨
            </button>
            <div class="staff-hint">
                –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –Ω–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É<br>–Ω–∞ QR-–∫–æ–¥ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
            </div>
        </div>

    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;
        const SECRET_KEY = "MY_SUPER_SECRET_KEY"; 

        // --- –°–ü–ò–°–û–ö –°–û–¢–†–£–î–ù–ò–ö–û–í ---
        const STAFF_IDS = [
            627287121, // –û–ª—è
            111111111  // –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º—É–∂–∞/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        ];

        // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê: –ö–¢–û –ü–†–ò–®–ï–õ? ---
        if (user && STAFF_IDS.includes(user.id)) {
            // –≠–¢–û –ö–ê–°–°–ò–†
            document.getElementById('staff-view').style.display = 'flex';
        } else {
            // –≠–¢–û –ö–õ–ò–ï–ù–¢
            document.getElementById('client-view').style.display = 'block';
            startClientLogic(); // –ó–∞–ø—É—Å–∫–∞–µ–º QR –∏ —Ç–∞–π–º–µ—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        }

        // --- –§–£–ù–ö–¶–ò–ò –ö–ê–°–°–ò–†–ê ---
        function openScanner() {
            tg.showScanQrPopup({
                text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞'
            }, (data) => {
                tg.closeScanQrPopup();
                // –¢—É—Ç –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É, –∏ –±–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç —Å—É–º–º—É
                tg.sendData(data); 
            });
        }

        // --- –§–£–ù–ö–¶–ò–ò –ö–õ–ò–ï–ù–¢–ê (QR, –¢–∞–π–º–µ—Ä) ---
        function startClientLogic() {
            if (user) document.getElementById('username').innerText = user.first_name;
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('balance').innerText = urlParams.get('balance') || "0";

            let timeLeft = 30;
            
            function updateTimer() {
                document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
                timeLeft--;
                if (timeLeft < 0) timeLeft = 30;
            }

            function generateQR() {
                const userId = user ? user.id.toString() : "DEMO";
                const timestamp = Math.floor(Date.now() / 1000);
                const dataToSign = userId + timestamp;
                const hash = CryptoJS.HmacSHA256(dataToSign, SECRET_KEY).toString(CryptoJS.enc.Hex);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞
                const qrData = JSON.stringify({
                    u: userId,
                    t: timestamp,
                    s: hash.substring(0, 10)
                });

                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { 
                    text: qrData, 
                    width: 200, height: 200,
                    correctLevel : QRCode.CorrectLevel.H
                });
                
                timeLeft = 30;
                updateTimer();
            }

            generateQR();
            setInterval(generateQR, 30000);
            setInterval(updateTimer, 1000);
        }

    </script>
</body>
</html>