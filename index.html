<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
        }
        
        .card {
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        
        .staff-card {
            background: white;
            border-radius: 24px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .user-name {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .balance-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 48px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 30px;
        }
        
        .qr-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 16px;
            margin: 25px 0;
            display: flex;
            justify-content: center;
        }
        
        .timer {
            font-size: 14px;
            color: #666;
            margin-top: 15px;
        }
        
        .staff-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s;
        }
        
        .staff-btn:active {
            transform: scale(0.95);
        }
        
        .staff-label {
            margin-top: 20px;
            color: white;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .loading {
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 50px;
        }
        
        .error {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: #dc3545;
        }
        
        .points-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏...
        </div>
        
        <div id="staff-view" class="staff-card" style="display: none;">
            <button class="staff-btn" onclick="openScanner()">
                üì∑<br>
                <span style="font-size: 18px;">–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</span><br>
                <span style="font-size: 14px; opacity: 0.9;">QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</span>
            </button>
            <div class="staff-label">
                –†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            </div>
            <div id="scan-result" style="margin-top: 20px; display: none;">
                <div class="points-badge" id="scan-user">–ö–ª–∏–µ–Ω—Ç</div>
                <div id="scan-balance" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div id="client-view" class="card" style="display: none;">
            <div class="user-name" id="user-name">–ì–æ—Å—Ç—å</div>
            <div class="balance-title">–í–∞—à –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤</div>
            <div class="balance-amount" id="balance">0</div>
            
            <div class="balance-title" style="margin-top: 30px;">–í–∞—à QR-–∫–æ–¥ –¥–ª—è –ø–æ–∫—É–ø–æ–∫</div>
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <div class="timer" id="timer">QR-–∫–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥</div>
            
            <div style="margin-top: 30px; font-size: 13px; color: #666; line-height: 1.5;">
                üì± –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –∫–∞—Å—Å–∏—Ä—É –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ<br>
                ‚ö°Ô∏è –ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            </div>
        </div>
        
        <div id="error-view" class="error" style="display: none;">
            <h3>–û—à–∏–±–∫–∞</h3>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç</p>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp;
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const STAFF_IDS = [627287121]; // ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        const SECRET_KEY = "loyalty-secret-key-2024"; // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        const QR_TTL = 60; // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ QR-–∫–æ–¥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        let currentUser = null;
        let qrCodeInstance = null;
        let qrTimer = null;
        let updateTimer = null;
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function initApp() {
            try {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                
                if (!tg) {
                    showError('Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                tg.expand();
                tg.enableClosingConfirmation();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser = tg.initDataUnsafe?.user;
                
                if (!currentUser) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ start_param
                const balance = tg.initDataUnsafe?.start_param || "0";
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading').style.display = 'none';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç)
                if (STAFF_IDS.includes(currentUser.id)) {
                    showStaffView();
                } else {
                    showClientView(currentUser.first_name, balance);
                    startQRGenerator();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function showStaffView() {
            document.getElementById('staff-view').style.display = 'block';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
        function showClientView(userName, balance) {
            document.getElementById('client-view').style.display = 'block';
            document.getElementById('user-name').textContent = userName;
            document.getElementById('balance').textContent = balance;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-view').style.display = 'block';
            document.getElementById('error-view').querySelector('p').textContent = message;
        }
        
        // –û—Ç–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞ (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)
        function openScanner() {
            if (!tg.showScanQrPopup) {
                tg.showAlert('–°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–æ–≤ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ Telegram');
                return;
            }
            
            const scanConfig = {
                text: "–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞"
            };
            
            tg.showScanQrPopup(scanConfig, (scannedData) => {
                if (!scannedData) {
                    console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    return;
                }
                
                console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', scannedData);
                
                try {
                    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ QR-–∫–æ–¥–∞
                    let userData;
                    
                    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                    if (scannedData.startsWith('http')) {
                        // –ï—Å–ª–∏ —ç—Ç–æ URL, –∏–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                        const url = new URL(scannedData);
                        const params = new URLSearchParams(url.search);
                        userData = {
                            u: params.get('u') || params.get('user'),
                            t: params.get('t') || params.get('time'),
                            s: params.get('s') || params.get('sign')
                        };
                    } else {
                        // –ï—Å–ª–∏ —ç—Ç–æ JSON
                        userData = JSON.parse(scannedData);
                    }
                    
                    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å
                    const isValid = validateQRSignature(userData.u, userData.t, userData.s);
                    
                    if (isValid) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                        const scanResult = document.getElementById('scan-result');
                        document.getElementById('scan-user').textContent = –ö–ª–∏–µ–Ω—Ç #${userData.u};
                        document.getElementById('scan-balance').innerHTML = `
                            <div style="color: #28a745; font-weight: bold; margin: 10px 0;">
                                –ì–æ—Ç–æ–≤ –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é –±–∞–ª–ª–æ–≤
                            </div>
                            <button onclick="processPayment('${userData.u}')" 
                                    style="background: #28a745; color: white; border: none; 
                                           padding: 10px 20px; border-radius: 10px; cursor: pointer;">
                                –í–≤–µ—Å—Ç–∏ —Å—É–º–º—É —á–µ–∫–∞
                            </button>
                        `;
                        scanResult.style.display = 'block';
                        
                        tg.showAlert('‚úÖ QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!');
                    } else {
                        tg.showAlert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR:', error);
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è QR-–∫–æ–¥–∞');
                }
            });
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ QR-–∫–æ–¥–∞
        function validateQRSignature(userId, timestamp, signature) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ QR-–∫–æ–¥–∞ (30 —Å–µ–∫—É–Ω–¥)
                const now = Math.floor(Date.now() / 1000);
                if (now - parseInt(timestamp) > 30) {
                    return false;
                }
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é –ø–æ–¥–ø–∏—Å—å
                const expectedSignature = CryptoJS.HmacSHA256(
                    userId + timestamp, 
                    SECRET_KEY
                ).toString().substring(0, 12);
                
                return signature === expectedSignature;
            } catch (error) {
                return false;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã (–¥–µ–º–æ)
        function processPayment(userId) {
            tg.showPopup({
                title: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞',
                message: '–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö:',
                buttons: [
                    {id: '500', type: 'default', text: '500 —Ä—É–±'},
                    {id: '1000', type: 'default', text: '1000 —Ä—É–±'},
                    {id: '1500', type: 'default', text: '1500 —Ä—É–±'},
                    {id: 'custom', type: 'default', text: '–î—Ä—É–≥–∞—è —Å—É–º–º–∞'},
                    {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                ]
            }, (buttonId) => {
                if (buttonId === 'custom') {
                    tg.showPopup({
                        title: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',
                        message: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞:',
                        buttons: [
                            {id: 'submit', type: 'default', text: '–ì–æ—Ç–æ–≤–æ'},
                            {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                        ]
                    });
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—É–º–º—ã
                } else if (buttonId !== 'cancel') {
                    const amount = parseInt(buttonId);
                    const points = Math.floor(amount * 0.05); // 5% –∫–µ—à–±—ç–∫
                    
                    tg.showAlert(‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${points} –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–∫—É–ø–∫—É –Ω–∞ ${amount} —Ä—É–±);
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    document.getElementById('scan-result').style.display = 'none';
                }
            });
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        function startQRGenerator() {
            let timeLeft = QR_TTL;
            
            function generateQR() {
                if (!currentUser) return;
                
                const timestamp = Math.floor(Date.now() / 1000);
                const signature = CryptoJS.HmacSHA256(
                    currentUser.id + timestamp, 
                    SECRET_KEY
                ).toString().substring(0, 12);
                
                // –°–æ–∑–¥–∞–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (Telegram –ª—É—á—à–µ —á–∏—Ç–∞–µ—Ç URL)
                const qrData = https://loyalty-system.app/scan?u=${currentUser.id}&t=${timestamp}&s=${signature}&b=${document.getElementById('balance').textContent};
                
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - JSON
                // const qrData = JSON.stringify({
                //     uid: currentUser.id,
                //     time: timestamp,
                //     sign: signature,
                //     balance: document.getElementById('balance').textContent
                // });
                
                const qrContainer = document.getElementById('qrcode');
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR-–∫–æ–¥
                qrContainer.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π QR-–∫–æ–¥
                qrCodeInstance = new QRCode(qrContainer, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                timeLeft = QR_TTL;
                console.log('QR-–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω:', qrData);
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ —Å—Ä–∞–∑—É
            generateQR();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ QR_TTL —Å–µ–∫—É–Ω–¥
            qrTimer = setInterval(generateQR, QR_TTL * 1000);
            
            // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
            updateTimer = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    document.getElementById('timer').textContent = 
                        QR-–∫–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫—É–Ω–¥;
                }
            }, 1000);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        function cleanup() {
            if (qrTimer) clearInterval(qrTimer);
            if (updateTimer) clearInterval(updateTimer);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–≥–¥–∞ Telegram Web App –≥–æ—Ç–æ–≤
        if (tg) {
            tg.ready();
            setTimeout(initApp, 100); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        } else {
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
            currentUser = { id: 123456, first_name: "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" };
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                showClientView(currentUser.first_name, "150");
                startQRGenerator();
            }, 1000);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>