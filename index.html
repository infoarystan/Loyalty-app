<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* –ö–õ–ò–ï–ù–¢ (–í–∏–¥–µ–Ω —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ—Ç—ã) */
        #client-view { text-align: center; width: 85%; max-width: 320px; background: var(--tg-theme-secondary-bg-color, #f0f0f0); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block; }
        .balance { font-size: 48px; font-weight: 800; color: #34C759; margin: 15px 0; }
        #qrcode { margin: 20px auto; background: white; padding: 15px; border-radius: 15px; display: inline-block; }
        #timer { font-size: 14px; opacity: 0.6; margin-top: 10px; font-variant-numeric: tabular-nums; }

        /* –ö–ê–°–°–ò–† (–°–∫—Ä—ã—Ç, –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–≤–µ—Ä–∏–º ID) */
        #staff-view { width: 100%; height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; background-color: var(--tg-theme-bg-color, #fff); position: absolute; top: 0; left: 0; z-index: 10; }
        .staff-btn { width: 250px; height: 250px; border-radius: 50%; background: linear-gradient(135deg, #007AFF, #0056b3); color: white; border: none; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(0,122,255,0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .staff-icon { font-size: 60px; margin-bottom: 10px; }
        
        /* –ë–ª–æ–∫ –¥–ª—è –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è) */
        #error-log { color: red; font-size: 12px; margin-top: 20px; text-align: center; white-space: pre-wrap; display: none;}
    </style>
</head>
<body>

    <div id="error-log"></div>

    <div class="container">
        <div id="client-view">
            <h2 id="username">–ì–æ—Å—Ç—å</h2>
            <div style="opacity: 0.7; font-size: 14px;">–í–∞—à–∏ –±–∞–ª–ª—ã:</div>
            <div class="balance" id="balance">0</div>
            <div id="qrcode"></div>
            <div id="timer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="staff-view">
            <button class="staff-btn" onclick="openScanner()">
                <div class="staff-icon">üì∑</div>
                –°–ö–ê–ù–ò–†–û–í–ê–¢–¨
            </button>
            <div style="margin-top:20px; opacity:0.5;">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω (—á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª–∞, –≤ —á–µ–º –¥–µ–ª–æ)
        window.onerror = function(msg, url, line) {
            const errDiv = document.getElementById('error-log');
            errDiv.style.display = 'block';
            errDiv.innerHTML += –û—à–∏–±–∫–∞: ${msg}<br>–°—Ç—Ä–æ–∫–∞: ${line}<br>;
            return false;
        };

        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;
        const SECRET_KEY = "MY_SUPER_SECRET_KEY"; 

        // !!! –¢–í–û–ô –°–ü–ò–°–û–ö ID !!!
        const STAFF_IDS = [ 627287121 ]; 

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —ç—Ç–æ –∫–∞—Å—Å–∏—Ä?
        try {
            if (user && STAFF_IDS.includes(user.id)) {
                // –ï—Å–ª–∏ –ö–∞—Å—Å–∏—Ä -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, —Å–∫—Ä—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
                document.getElementById('staff-view').style.display = 'flex';
                document.getElementById('client-view').style.display = 'none';
            } else {
                // –ï—Å–ª–∏ –ö–ª–∏–µ–Ω—Ç -> –ó–∞–ø—É—Å–∫–∞–µ–º QR
                startClientLogic();
            }
        } catch (e) {
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ - –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            console.error(e);
            startClientLogic();
        }

        // --- –§–£–ù–ö–¶–ò–ò ---
        function openScanner() {
            tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞' }, (data) => {
                tg.closeScanQrPopup();
                tg.sendData(data); 
            });
        }

        function startClientLogic() {
            if (user) document.getElementById('username').innerText = user.first_name;
            
            const urlParams = new URLSearchParams(window.location.search);
            const balanceVal = urlParams.get('balance');
            if(balanceVal) document.getElementById('balance').innerText = balanceVal;

            let timeLeft = 30;
            
            function generateQR() {
                const userId = user ? user.id.toString() : "DEMO";
                const timestamp = Math.floor(Date.now() / 1000);
                const dataToSign = userId + timestamp;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è?
                let hash = "error";
                if (typeof CryptoJS !== 'undefined') {
                    hash = CryptoJS.HmacSHA256(dataToSign, SECRET_KEY).toString(CryptoJS.enc.Hex);
                } else {
                    document.getElementById('error-log').innerText += "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ crypto-js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å!\n";
                }
                
                const qrData = JSON.stringify({ u: userId, t: timestamp, s: hash.substring(0, 10) });

                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, { text: qrData, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });
                
                timeLeft = 30;
                document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
            }

            generateQR();
            setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) { generateQR(); }
                else { document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫; }
            }, 1000);
        }
    </script>
</body>
</html>