<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; text-align: center; padding-top: 50px; margin: 0; }
        .btn { width: 200px; height: 200px; border-radius: 50%; background: #007AFF; color: white; border: none; font-size: 20px; font-weight: bold; }
        .card { background: white; margin: 20px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="main">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); // –°–æ–æ–±—â–∞–µ–º –¢–µ–ª–µ–≥—Ä–∞–º—É, —á—Ç–æ –º—ã –∂–∏–≤—ã
        tg.expand();

        const STAFF_IDS = [627287121]; 
        const user = tg.initDataUnsafe?.user;

        if (!user) {
            document.getElementById('main').innerHTML = "–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram";
        } else {
            if (STAFF_IDS.includes(user.id)) {
                // –≠–ö–†–ê–ù –ö–ê–°–°–ò–†–ê
                document.getElementById('main').innerHTML = `
                    <button class="btn" onclick="scan()">üì∑<br>–°–ö–ê–ù</button>
                    <p>–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
                `;
            } else {
                // –≠–ö–†–ê–ù –ö–õ–ò–ï–ù–¢–ê
                const bal = tg.initDataUnsafe?.start_param || "0";
                document.getElementById('main').innerHTML = `
                    <div class="card">
                        <h2>${user.first_name}</h2>
                        <h1 style="color:#28a745; font-size:40px;">${bal}</h1>
                        <div id="qrcode"></div>
                        <p id="timer" style="color:#888;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</p>
                    </div>
                `;
                renderQR(user.id);
            }
        }

        function scan() {
            tg.showScanQrPopup({ text: "–°–∫–∞–Ω–∏—Ä—É–π" }, (data) => {
                if (data) {
                    [span_4](start_span)tg.sendData(data); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º[span_4](end_span)
                }
            });
        }

        function renderQR(uid) {
            let sec = 60;
            const draw = () => {
                const ts = Math.floor(Date.now() / 1000);
                const hash = CryptoJS.HmacSHA256(uid + ts, "SECRET").toString().substring(0, 10);
                const payload = JSON.stringify({u:uid, t:ts, s:hash});
                
                document.getElementById("qrcode").innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: payload, width: 200, height: 200 });
                sec = 60;
            };
            draw();
            setInterval(draw, 60000);
            setInterval(() => {
                sec--;
                if (sec >= 0) document.getElementById("timer").innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ " + sec + " —Å–µ–∫";
            }, 1000);
        }
    </script>
</body>
</html>