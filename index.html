<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #staff-view, #client-view { display: none; text-align: center; width: 90%; max-width: 350px; }
        .staff-btn { width: 220px; height: 220px; border-radius: 50%; background: #007AFF; color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(0,122,255,0.3); }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .balance { font-size: 50px; font-weight: bold; color: #28a745; margin: 10px 0; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin: 15px 0; }
    </style>
</head>
<body>
    <div id="staff-view">
        <button class="staff-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
        <p style="margin-top:20px; opacity:0.6;">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
    </div>

    <div id="client-view" class="card">
        <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div class="balance" id="balance">0</div>
        <div id="qrcode"></div>
        <div id="timer" style="color:#888; font-size:14px;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;
        const SECRET_KEY = "SECRET"; // –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ n8n
        const STAFF_IDS = [627287121]; // –¢–≤–æ–π ID

        if (!user) {
            document.body.innerHTML = '<h3 style="padding:20px; text-align:center;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Telegram</h3>';
        } else {
            initApp();
        }

        function initApp() {
            // –ë–∞–ª–∞–Ω—Å –∏–∑ start_param (—Ç–≤–æ—è –ø—Ä–∞–≤–∫–∞)
            const startParam = tg.initDataUnsafe?.start_param || "0";
            document.getElementById('balance').innerText = startParam;

            if (STAFF_IDS.includes(user.id)) {
                document.getElementById('staff-view').style.display = 'block';
            } else {
                document.getElementById('client-screen' || 'client-view').style.display = 'block';
                document.getElementById('username').innerText = user.first_name;
                startLoyaltyLogic();
            }
        }

        // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –°–ö–ê–ù–ï–†–ê (—Å–æ–≥–ª–∞—Å–Ω–æ –≤–ª–æ–∂–µ–Ω–∏—é)
        function openScanner() {
            tg.showScanQrPopup(
                { text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞' },
                (data) => {
                    if (!data) return;
                    // Telegram —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç –ø–æ–ø–∞–ø, –Ω–æ –º—ã –º–æ–∂–µ–º –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å—Å—è
                    tg.closeScanQrPopup();
                    tg.sendData(data); // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
                }
            );
        }

        function startLoyaltyLogic() {
            let timeLeft = 30;
            const updateQR = () => {
                const ts = Math.floor(Date.now() / 1000);
                // HMAC-–ø–æ–¥–ø–∏—Å—å —Å–æ–≥–ª–∞—Å–Ω–æ –ì–ª–∞–≤–µ 8.1
                const hash = CryptoJS.HmacSHA256(user.id + ts, SECRET_KEY).toString(CryptoJS.enc.Hex).substring(0, 10);
                
                [span_7](start_span)// –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π JSON –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è[span_7](end_span)
                const qrData = JSON.stringify({u:user.id,t:ts,s:hash});
                
                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, { 
                    text: qrData, 
                    width: 200, 
                    height: 200, 
                    [span_8](start_span)correctLevel: QRCode.CorrectLevel.L // –£—Ä–æ–≤–µ–Ω—å L –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã[span_8](end_span)
                });
                timeLeft = 30;
            };

            updateQR();
            setInterval(updateQR, 30000);
            setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    document.getElementById('timer').innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ " + timeLeft + " —Å–µ–∫";
                }
            }, 1000);
        }
    </script>
</body>
</html>