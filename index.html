<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .client-view {
            background: white;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .staff-view {
            text-align: center;
            padding-top: 40px;
        }
        
        h1 {
            color: #333;
            margin: 0 0 8px 0;
            font-size: 20px;
        }
        
        .balance {
            color: #28a745;
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        #qrcode {
            margin: 20px auto;
            padding: 16px;
            background: white;
            border-radius: 12px;
            display: inline-block;
        }
        
        .timer {
            color: #666;
            font-size: 14px;
            margin-top: 12px;
        }
        
        .scan-btn {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: #007AFF;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div id="clientScreen" class="screen">
        <div class="client-view">
            <h1 id="clientName">–ö–ª–∏–µ–Ω—Ç</h1>
            <div class="balance" id="clientBalance">0</div>
            <div>–í–∞—à QR-–∫–æ–¥:</div>
            <div id="qrcode"></div>
            <div class="timer" id="timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 —Å–µ–∫</div>
        </div>
    </div>
    
    <div id="staffScreen" class="screen">
        <div class="staff-view">
            <button class="scan-btn" onclick="scanQR()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
            <p>–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
        </div>
    </div>

<script>
// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
const STAFF_IDS = [627287121, 123456789]; // –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
const QR_LIFETIME = 60; // —Å–µ–∫—É–Ω–¥

// ===== –û–°–ù–û–í–ù–û–ô –ö–û–î =====
let tg = window.Telegram.WebApp;
let isStaff = false;
let qrTimer = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function init() {
    console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");
    
    if (!tg) {
        showError("–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram");
        return;
    }
    
    tg.expand();
    tg.ready();
    
    const user = tg.initDataUnsafe?.user;
    
    if (!user) {
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ");
        return;
    }
    
    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.id);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
    isStaff = STAFF_IDS.includes(parseInt(user.id));
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('loading').style.display = 'none';
    
    if (isStaff) {
        // –†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        document.getElementById('staffScreen').classList.add('active');
        console.log("–ó–∞–≥—Ä—É–∂–µ–Ω —Ä–µ–∂–∏–º –°–û–¢–†–£–î–ù–ò–ö–ê");
    } else {
        // –†–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
        document.getElementById('clientScreen').classList.add('active');
        document.getElementById('clientName').textContent = user.first_name || "–ö–ª–∏–µ–Ω—Ç";
        
        // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞
        const balance = tg.initDataUnsafe?.start_param || "0";
        document.getElementById('clientBalance').textContent = balance;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR
        generateQR(user.id);
        console.log("–ó–∞–≥—Ä—É–∂–µ–Ω —Ä–µ–∂–∏–º –ö–õ–ò–ï–ù–¢–ê");
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
function generateQR(userId) {
    function updateQR() {
        const timestamp = Math.floor(Date.now() / 1000);
        const data = LOYALTY:${userId}:${timestamp};
        
        const qr = qrcode(0, 'M');
        qr.addData(data);
        qr.make();
        
        document.getElementById('qrcode').innerHTML = qr.createImgTag(6, 0);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        startTimer();
    }
    
    function startTimer() {
        let timeLeft = QR_LIFETIME;
        
        function updateTimer() {
            document.getElementById('timer').textContent = 
                –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
            timeLeft--;
            
            if (timeLeft < 0) {
                updateQR();
            }
        }
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
        if (qrTimer) clearInterval(qrTimer);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
        updateTimer();
        qrTimer = setInterval(updateTimer, 1000);
    }
    
    updateQR();
}

// –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)
function scanQR() {
    if (!tg.showScanQrPopup) {
        tg.showAlert("–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
        return;
    }
    
    tg.showScanQrPopup(
        {text: "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞"},
        function(scannedData) {
            if (!scannedData) {
                console.log("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ");
                return;
            }
            
            console.log("–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", scannedData);
            
            // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ QR
            const parts = scannedData.split(':');
            if (parts[0] === 'LOYALTY' && parts.length === 3) {
                const userId = parts[1];
                const timestamp = parseInt(parts[2]);
                const now = Math.floor(Date.now() / 1000);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–µ—Å—Ç—å QR (–Ω–µ —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç)
                if (now - timestamp > 120) {
                    tg.showAlert("QR-–∫–æ–¥ —É—Å—Ç–∞—Ä–µ–ª");
                    return;
                }
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—É–º–º—É
                tg.showPopup({
                    title: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞",
                    message: "–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö:",
                    buttons: [
                        {id: '500', type: 'default', text: '500'},
                        {id: '1000', type: 'default', text: '1000'},
                        {id: '1500', type: 'default', text: '1500'},
                        {id: 'other', type: 'default', text: '–î—Ä—É–≥–∞—è —Å—É–º–º–∞'},
                        {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                    ]
                }, function(btnId) {
                    if (btnId === 'other') {
                        tg.showPopup({
                            title: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É",
                            message: "–ù–∞–ø—Ä–∏–º–µ—Ä: 750",
                            buttons: [
                                {id: 'submit', type: 'default', text: '–ì–æ—Ç–æ–≤–æ'},
                                {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                            ]
                        });
                    } else if (btnId !== 'cancel') {
                        const amount = parseInt(btnId);
                        const points = Math.floor(amount * 0.05); // 5% –∫–µ—à–±—ç–∫
                        tg.showAlert(‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${points} –±–∞–ª–ª–æ–≤);
                    }
                });
            } else {
                tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥");
            }
        }
    );
}

// –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
function showError(msg) {
    document.getElementById('loading').innerHTML = <div style="color: red; padding: 40px; text-align: center">${msg}</div>;
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>