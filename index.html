<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            margin-top: 50%;
        }
        
        /* –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –≤–∏–¥ */
        .client-view {
            background: white;
            padding: 20px;
            min-height: 100%;
        }
        
        .client-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin: 20px 0 10px;
        }
        
        .balance-label {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .balance {
            text-align: center;
            color: #28a745;
            font-size: 48px;
            font-weight: bold;
            margin: 0 0 30px;
        }
        
        .qr-section {
            text-align: center;
            margin: 30px 0;
        }
        
        .qr-label {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        
        .timer {
            color: #888;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
        }
        
        /* –í–∏–¥ –∫–∞—Å—Å–∏—Ä–∞ */
        .staff-view {
            text-align: center;
            padding: 40px 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .staff-btn {
            width: 200px;
            height: 200px;
            border-radius: 100px;
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            border: none;
            font-size: 20px;
            font-weight: bold;
            margin: 0 auto 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }
        
        .staff-btn:active {
            transform: scale(0.98);
        }
        
        .staff-label {
            color: #666;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .error {
            text-align: center;
            padding: 40px 20px;
            color: #dc3545;
        }
        
        @media (max-width: 480px) {
            .client-view {
                padding: 15px;
            }
            
            .balance {
                font-size: 42px;
            }
            
            .staff-btn {
                width: 180px;
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        
        <div id="clientView" style="display: none;">
            <div class="client-view">
                <div class="client-name" id="clientName">–ö–ª–∏–µ–Ω—Ç</div>
                <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div class="balance" id="clientBalance">0</div>
                
                <div class="qr-section">
                    <div class="qr-label">QR-–∫–æ–¥ –¥–ª—è –∫–∞—Å—Å–∏—Ä–∞</div>
                    <div id="qrcode"></div>
                    <div class="timer" id="timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 —Å–µ–∫</div>
                </div>
                
                <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
                    üì± –ü–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥ –∫–∞—Å—Å–∏—Ä—É –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
                </div>
            </div>
        </div>
        
        <div id="staffView" style="display: none;">
            <div class="staff-view">
                <button class="staff-btn" onclick="startScan()">
                    üì∑<br>
                    <span style="font-size: 18px;">–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</span><br>
                    <span style="font-size: 14px; opacity: 0.9;">QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞</span>
                </button>
                <div class="staff-label">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
            </div>
        </div>
        
        <div id="errorView" style="display: none;" class="error">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram.
        </div>
    </div>

<script>
// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
const STAFF_IDS = [627287121]; // –í–∞—à ID –∫–∞—Å—Å–∏—Ä–∞
const QR_SECRET = "loyalty2024";

// ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
let tg = null;
let user = null;
let qrInterval = null;
let timerInterval = null;

// ===== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
function initApp() {
    console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App");
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç Telegram Web App
    tg = window.Telegram?.WebApp;
    
    if (!tg) {
        console.error("Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω");
        showError();
        return;
    }
    
    console.log("Telegram Web App –≤–µ—Ä—Å–∏—è:", tg.version);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
    try {
        tg.ready();
        tg.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = tg.initDataUnsafe?.user;
        
        if (!user) {
            console.error("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã");
            showError();
            return;
        }
        
        console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.id, user.first_name);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º (–∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –∫–∞—Å—Å–∏—Ä)
        const isStaff = STAFF_IDS.includes(parseInt(user.id));
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loading').style.display = 'none';
        
        if (isStaff) {
            // –†–µ–∂–∏–º –∫–∞—Å—Å–∏—Ä–∞
            console.log("–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∂–∏–º –ö–ê–°–°–ò–†–ê");
            document.getElementById('staffView').style.display = 'block';
        } else {
            // –†–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
            console.log("–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∂–∏–º –ö–õ–ò–ï–ù–¢–ê");
            document.getElementById('clientView').style.display = 'block';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è
            document.getElementById('clientName').textContent = user.first_name || '–ö–ª–∏–µ–Ω—Ç';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ start_param
            const balance = tg.initDataUnsafe?.start_param || "0";
            document.getElementById('clientBalance').textContent = balance;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
            generateQR();
        }
        
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
        showError();
    }
}

// ===== –ì–ï–ù–ï–†–ê–¶–ò–Ø QR-–ö–û–î–ê =====
function generateQR() {
    if (!user) return;
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π QR-–∫–æ–¥ —Å –¥–∞–Ω–Ω—ã–º–∏
    const data = {
        uid: user.id,
        ts: Date.now(),
        t: 'loyalty'
    };
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
    const qrData = JSON.stringify(data);
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π QR
    document.getElementById('qrcode').innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º QR-–∫–æ–¥ —Å –ø–æ–º–æ—â—å—é canvas (—Å–∞–º—ã–π –ª–µ–≥–∫–∏–π —Å–ø–æ—Å–æ–±)
    const qrSize = Math.min(window.innerWidth - 80, 300);
    const qrCanvas = document.createElement('canvas');
    qrCanvas.width = qrSize;
    qrCanvas.height = qrSize;
    const ctx = qrCanvas.getContext('2d');
    
    // –†–∏—Å—É–µ–º –ø—Ä–æ—Å—Ç–æ–π QR-–∫–æ–¥ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
    drawSimpleQR(ctx, qrData, qrSize);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.getElementById('qrcode').appendChild(qrCanvas);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    startTimer();
}

// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è QR (–¥–ª—è –¥–µ–º–æ)
function drawSimpleQR(ctx, data, size) {
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, size, size);
    
    ctx.fillStyle = '#000000';
    
    // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –¥–µ–º–æ
    const hash = data.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
    }, 0);
    
    const patternSize = 10;
    const cols = Math.floor(size / patternSize);
    
    for (let i = 0; i < cols; i++) {
        for (let j = 0; j < cols; j++) {
            if ((hash + i * cols + j) % 2 === 0) {
                ctx.fillRect(i * patternSize, j * patternSize, patternSize, patternSize);
            }
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–º–∫—É
    ctx.strokeStyle = '#007AFF';
    ctx.lineWidth = 3;
    ctx.strokeRect(5, 5, size - 10, size - 10);
}

// ===== –¢–ê–ô–ú–ï–† –û–ë–ù–û–í–õ–ï–ù–ò–Ø QR =====
function startTimer() {
    let seconds = 60;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
    function updateTimer() {
        document.getElementById('timer').textContent = 
            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫;
        
        seconds--;
        
        if (seconds < 0) {
            // –û–±–Ω–æ–≤–ª—è–µ–º QR-–∫–æ–¥
            generateQR();
        }
    }
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
    if (timerInterval) clearInterval(timerInterval);
    if (qrInterval) clearInterval(qrInterval);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º QR –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
    qrInterval = setInterval(generateQR, 60000);
}

// ===== –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï QR (–î–õ–Ø –ö–ê–°–°–ò–†–ê) =====
function startScan() {
    if (!tg?.showScanQrPopup) {
        tg.showAlert('–°–∫–∞–Ω–µ—Ä QR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ Telegram');
        return;
    }
    
    tg.showScanQrPopup(
        {
            text: "–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞"
        },
        function(scannedData) {
            if (!scannedData) {
                console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                return;
            }
            
            console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', scannedData);
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                const data = JSON.parse(scannedData);
                
                if (data.uid && data.t === 'loyalty') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ —Å—É–º–º—ã
                    tg.showPopup({
                        title: '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤',
                        message: '–ö–ª–∏–µ–Ω—Ç #' + data.uid + '\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–µ–∫–∞:',
                        buttons: [
                            {id: '500', type: 'default', text: '500 ‚ÇΩ'},
                            {id: '1000', type: 'default', text: '1000 ‚ÇΩ'},
                            {id: '1500', type: 'default', text: '1500 ‚ÇΩ'},
                            {id: 'other', type: 'default', text: '–î—Ä—É–≥–∞—è —Å—É–º–º–∞'},
                            {type: 'cancel'}
                        ]
                    }, function(buttonId) {
                        if (buttonId === 'other') {
                            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Å—É–º–º—É
                            tg.showPopup({
                                title: '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',
                                message: '–ù–∞–ø—Ä–∏–º–µ—Ä: 750',
                                buttons: [
                                    {id: 'submit', type: 'default', text: '–ì–æ—Ç–æ–≤–æ'},
                                    {type: 'cancel'}
                                ]
                            });
                        } else if (buttonId) {
                            const amount = parseInt(buttonId);
                            const points = Math.floor(amount * 0.05); // 5% –∫–µ—à–±—ç–∫
                            tg.showAlert(‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${points} –±–∞–ª–ª–æ–≤!);
                        }
                    });
                } else {
                    tg.showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥');
                }
            } catch (e) {
                tg.showAlert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è QR-–∫–æ–¥–∞');
            }
        }
    );
}

// ===== –ü–û–ö–ê–ó –û–®–ò–ë–ö–ò =====
function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorView').style.display = 'block';
}

// ===== –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ =====
// –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // –î–∞–µ–º Telegram –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    setTimeout(initApp, 100);
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
window.addEventListener('beforeunload', function() {
    if (qrInterval) clearInterval(qrInterval);
    if (timerInterval) clearInterval(timerInterval);
});
</script>
</body>
</html>