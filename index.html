<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f4f9; margin:0; display:flex; justify-content:center; align-items:center; height:100vh; overflow: hidden; }
        #staff-view, #client-view { display: none; text-align:center; width:90%; max-width:350px; }
        .staff-btn { width:220px; height:220px; border-radius:50%; background:linear-gradient(135deg,#007AFF,#0056b3); color:white; border:none; font-size:22px; font-weight:bold; cursor:pointer; box-shadow:0 8px 25px rgba(0,122,255,0.4); }
        .card { background:white; padding:25px; border-radius:25px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
        .balance { font-size:50px; font-weight:bold; color:#28a745; margin:10px 0; }
        #qrcode { background:white; padding:15px; border-radius:15px; display:inline-block; margin:15px 0; border:1px solid #eee; }
        #timer { color:#8e8e93; font-size:14px; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>
    <div id="staff-view">
        <button class="staff-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
        <p style="margin-top:25px; font-weight:500;">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
    </div>

    <div id="client-view" class="card">
        <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p style="color:#8e8e93; margin:5px 0 0;">–í–∞—à–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã</p>
        <div class="balance" id="balance">0</div>
        <div id="qrcode"></div>
        <div id="timer">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞...</div>
    </div>

<script>
const STAFF_IDS = [627287121]; 
const SECRET_KEY = "MY_SECRET_KEY"; 
let tg = window.Telegram.WebApp;

// –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ
tg.ready();
tg.expand();

const user = tg.initDataUnsafe?.user;

if (!user) {
    document.body.innerHTML = '<h3 style="padding:20px; text-align:center;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Telegram</h3>';
} else {
    initApp();
}

function initApp() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–π –º–µ—Ç–æ–¥ start_param –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
    const startBalance = tg.initDataUnsafe?.start_param || "0";
    document.getElementById('balance').innerText = startBalance;

    if (STAFF_IDS.includes(user.id)) {
        document.getElementById('staff-view').style.display = 'block';
    } else {
        document.getElementById('client-view').style.display = 'block';
        document.getElementById('username').innerText = user.first_name || "–ì–æ—Å—Ç—å";
        startLoyaltyCycle();
    }
}

function openScanner() {
    tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞' }, (data) => {
        if (!data) return;
        [span_9](start_span)// –ü–æ —Ç–≤–æ–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ[span_9](end_span)
        tg.closeScanQrPopup();
        tg.sendData(data); 
    });
}

function startLoyaltyCycle() {
    let timeLeft = 30;

    function updateQR() {
        try {
            const timestamp = Math.floor(Date.now() / 1000);
            // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
            const hash = CryptoJS.HmacSHA256(user.id.toString() + timestamp.toString(), SECRET_KEY).toString(CryptoJS.enc.Hex).substring(0,10);

            [span_10](start_span)// –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π JSON –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ (–ì–ª–∞–≤–∞ 8.2)[span_10](end_span)
            const qrData = JSON.stringify({u:user.id,t:timestamp,s:hash});

            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = "";
            new QRCode(qrDiv, { 
                text: qrData, 
                width:200, 
                height:200, 
                correctLevel: QRCode.CorrectLevel.M 
            });
            timeLeft = 30;
        } catch (e) {
            console.error("QR Error:", e);
        }
    }

    updateQR();
    setInterval(updateQR, 30000);

    setInterval(() => {
        timeLeft--;
        if (timeLeft >= 0) {
            document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
        }
    }, 1000);
}
</script>
</body>
</html>