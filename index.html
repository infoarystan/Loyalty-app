<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty Platform</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f4f9; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #staff-screen, #client-screen { display: none; text-align: center; width: 90%; max-width: 350px; }
        
        /* –ö–∞—Å—Å–∏—Ä */
        .big-btn { width: 220px; height: 220px; border-radius: 50%; background: linear-gradient(135deg, #007AFF, #0056b3); color: white; border: none; font-size: 22px; font-weight: bold; box-shadow: 0 8px 25px rgba(0,122,255,0.4); cursor: pointer; }
        
        /* –ö–ª–∏–µ–Ω—Ç */
        .card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .balance { font-size: 54px; font-weight: 800; color: #28a745; margin: 10px 0; }
        #qrcode { background: white; padding: 15px; border-radius: 15px; display: inline-block; margin: 15px 0; border: 1px solid #eee; }
        #timer { color: #8e8e93; font-size: 14px; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>

    <div id="staff-screen">
        <button class="big-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
        <p style="margin-top:25px; font-weight:500;">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
    </div>

    <div id="client-screen" class="card">
        <h2 id="username" style="margin:0; font-size:24px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p style="color:#8e8e93; margin:5px 0 0;">–í–∞—à–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã</p>
        <div class="balance" id="balance">0</div>
        <div id="qrcode"></div>
        <div id="timer">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const user = tg.initDataUnsafe?.user;
        const SECRET_KEY = "MY_SUPER_SECRET_KEY"; [span_6](start_span)// –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å n8n[span_6](end_span)
        const STAFF_IDS = [ 627287121 ]; [span_7](start_span)// –¢–≤–æ–π ID –∫–∞—Å—Å–∏—Ä–∞[span_7](end_span)

        [span_8](start_span)[span_9](start_span)// --- –ü–†–ê–í–ö–ê 1: –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–Ω–µ Telegram[span_8](end_span)[span_9](end_span) ---
        if (!user) {
            document.body.innerHTML = '<h3 style="padding:20px; text-align:center;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram</h3>';
        } else {
            initApp();
        }

        function initApp() {
            [span_10](start_span)// --- –ü–†–ê–í–ö–ê 2: –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Å—Å—ã–ª–∫–∏ –∏–ª–∏ start_param[span_10](end_span) ---
            const urlParams = new URLSearchParams(window.location.search);
            const balanceFromUrl = urlParams.get('balance');
            const balanceFromStart = tg.initDataUnsafe?.start_param;
            
            const finalBalance = balanceFromUrl || balanceFromStart || "0";
            document.getElementById('balance').innerText = finalBalance;

            [span_11](start_span)// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏: –ö–∞—Å—Å–∏—Ä –∏–ª–∏ –ö–ª–∏–µ–Ω—Ç[span_11](end_span)
            if (STAFF_IDS.includes(user.id)) {
                document.getElementById('staff-screen').style.display = 'block';
            } else {
                document.getElementById('client-screen').style.display = 'block';
                document.getElementById('username').innerText = user.first_name;
                startLoyaltyCycle();
            }
        }

        function openScanner() {
            tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞' }, (data) => {
                tg.closeScanQrPopup();
                [span_12](start_span)tg.sendData(data); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON –±–æ—Ç—É[span_12](end_span)
            });
        }

        function startLoyaltyCycle() {
            let timeLeft = 30;

            function updateQR() {
                const timestamp = Math.floor(Date.now() / 1000);
                const hash = CryptoJS.HmacSHA256(user.id + timestamp, SECRET_KEY).toString(CryptoJS.enc.Hex);
                
                const qrData = JSON.stringify({
                    u: user.id,
                    t: timestamp,
                    s: hash.substring(0, 10)
                }); [span_13](start_span)// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π QR —Å–æ–≥–ª–∞—Å–Ω–æ –ì–ª–∞–≤–µ 8.1[span_13](end_span)

                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    correctLevel: QRCode.CorrectLevel.M
                });
                timeLeft = 30;
            }

            updateQR();
            setInterval(updateQR, 30000); [span_14](start_span)// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫[span_14](end_span)
            
            setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
                }
            }, 1000);
        }
    </script>
</body>
</html>