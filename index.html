<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #staff-screen, #client-screen { display: none; text-align: center; width: 90%; max-width: 350px; }
        .big-btn { width: 220px; height: 220px; border-radius: 50%; background: #007AFF; color: white; border: none; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(0,122,255,0.3); }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .balance { font-size: 50px; font-weight: bold; color: #28a745; margin: 10px 0; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin: 15px 0; }
    </style>
</head>
<body>
    <div id="staff-screen">
        <button class="big-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
    </div>
    <div id="client-screen" class="card">
        <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div class="balance" id="balance">0</div>
        <div id="qrcode"></div>
        <div id="timer" style="color:#888;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user;
        const STAFF_IDS = [627287121]; [span_6](start_span)[span_7](start_span)// –¢–≤–æ–π ID[span_6](end_span)[span_7](end_span)

        if (!user) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram"); // –¢–≤–æ—è –ø—Ä–∞–≤–∫–∞!
        } else {
            const bal = tg.initDataUnsafe?.start_param || "0"; // –¢–≤–æ—è –ø—Ä–∞–≤–∫–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞!
            document.getElementById('balance').innerText = bal;

            if (STAFF_IDS.includes(user.id)) {
                document.getElementById('staff-screen').style.display = 'block';
            } else {
                document.getElementById('client-screen').style.display = 'block';
                document.getElementById('username').innerText = user.first_name;
                startQR();
            }
        }

        function openScanner() {
            tg.showScanQrPopup({ text: '–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–ª–∏–µ–Ω—Ç–∞' }, (data) => {
                tg.closeScanQrPopup();
                [span_8](start_span)tg.sendData(data); // –ü–µ—Ä–µ–¥–∞–µ–º JSON –≤ n8n[span_8](end_span)
            });
        }

        function startQR() {
            const update = () => {
                const ts = Math.floor(Date.now() / 1000);
                const hash = CryptoJS.HmacSHA256(user.id + ts, "SECRET").toString().substring(0, 10);
                [span_9](start_span)const data = JSON.stringify({ u: user.id, t: ts, s: hash });[span_9](end_span)
                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, { text: data, width: 180, height: 180 });
            };
            update();
            [span_10](start_span)setInterval(update, 30000);[span_10](end_span)
        }
    </script>
</body>
</html>