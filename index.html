<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Loyalty App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
    body { font-family: -apple-system, sans-serif; background: #f4f4f9; margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center; }
    #staff-view, #client-view { display: none; text-align: center; width: 90%; max-width: 360px; }
    .staff-btn { width: 220px; height: 220px; border-radius: 50%; background: #007AFF; color: #fff; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 8px 20px rgba(0,122,255,0.3); cursor: pointer; }
    .card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,.1); }
    .balance { font-size: 52px; font-weight: bold; color: #28a745; margin: 10px 0; }
    #qrcode { margin: 20px 0; display: flex; justify-content: center; }
    #timer { color: #888; font-size: 14px; margin-top: 10px; }
</style>
</head>
<body>

<div id="staff-view">
    <button class="staff-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
    <p style="opacity:.6">–†–µ–∂–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>
</div>

<div id="client-view" class="card">
    <h2 id="username">–ì–æ—Å—Ç—å</h2>
    <div class="balance" id="balance">0</div>
    <div id="qrcode"></div>
    <div id="timer">–ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 60 —Å–µ–∫</div>
</div>

<script>
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å—ë –≤ try-catch, —á—Ç–æ–±—ã –ü–†–ï–î–û–¢–í–†–ê–¢–ò–¢–¨ –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω –ø—Ä–∏ –æ—à–∏–±–∫–µ
    try {
        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe?.user;
        const SECRET_KEY = "SECRET"; 
        const STAFF_IDS = [627287121]; 
        const QR_TTL = 60;

        if (!user) {
            document.body.innerHTML = '<h3 style="padding:20px;text-align:center">–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram</h3>';
        } else {
            initApp();
        }

        function initApp() {
            const balance = tg.initDataUnsafe?.start_param || "0";
            document.getElementById("balance").innerText = balance;

            if (STAFF_IDS.includes(user.id)) {
                document.getElementById("staff-view").style.display = "block";
            } else {
                document.getElementById("client-view").style.display = "block";
                document.getElementById("username").innerText = user.first_name;
                startQR();
            }
        }

        function openScanner() {
            tg.showScanQrPopup({ text: "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞" }, (scannedData) => {
                if (!scannedData) return;
                
                // –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É. 
                // n8n —Å–∞–º —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è, JSON —ç—Ç–æ –∏–ª–∏ –Ω–µ—Ç. –¢–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ!
                tg.sendData(scannedData); 
                
                [span_8](start_span)// –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ sendData –Ω–∏—á–µ–≥–æ –Ω–µ –ø–∏—à–µ–º, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è.[span_8](end_span)
            });
        }

        function startQR() {
            let timeLeft = QR_TTL;

            function generateQR() {
                const ts = Math.floor(Date.now() / 1000);
                const nonce = Math.random().toString(36).substring(2, 10);
                const sign = CryptoJS.HmacSHA256(user.id + ts + nonce, SECRET_KEY).toString(CryptoJS.enc.Hex).substring(0, 12);

                const payload = JSON.stringify({u: user.id, t: ts, n: nonce, s: sign});

                const qrDiv = document.getElementById("qrcode");
                qrDiv.innerHTML = "";
                
                new QRCode(qrDiv, {
                    text: payload,
                    width: 220,
                    height: 220,
                    correctLevel: QRCode.CorrectLevel.M
                });
                timeLeft = QR_TTL;
            }

            generateQR();
            setInterval(generateQR, QR_TTL * 1000);
            setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    document.getElementById("timer").innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
                }
            }, 1000);
        }
    } catch (e) {
        // –ï—Å–ª–∏ —Å–ª—É—á–∏—Ç—Å—è –ª—é–±–∞—è –æ—à–∏–±–∫–∞, –º—ã —É–≤–∏–¥–∏–º –µ—ë —Ç–µ–∫—Å—Ç, –∞ –Ω–µ –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω
        document.body.innerHTML = '<div style="color:red; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + e.message + '</div>';
    }
</script>
</body>
</html>