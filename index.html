<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loyalty</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #fff; color: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ö–∞—Å—Å–∏—Ä–∞ */
        #staff-screen { display: none; text-align: center; }
        .big-btn { width: 200px; height: 200px; border-radius: 50%; background: #007AFF; color: white; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ö–ª–∏–µ–Ω—Ç–∞ */
        #client-screen { display: none; text-align: center; width: 85%; max-width: 320px; background: #f2f2f7; padding: 20px; border-radius: 20px; }
        .balance { font-size: 48px; font-weight: 800; color: #34C759; margin: 10px 0; }
        #qrcode { background: white; padding: 10px; border-radius: 10px; display: inline-block; margin: 15px 0; }
        #qrcode img { display: block; } /* –§–∏–∫—Å –¥–ª—è –±–µ–ª–æ–π —Ç–æ—á–∫–∏ */
        
        /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (—á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª–∞ —Å–≤–æ–π ID) */
        #debug-info { position: absolute; bottom: 10px; font-size: 10px; color: #ccc; }
    </style>
</head>
<body>

    <div id="staff-screen">
        <button class="big-btn" onclick="openScanner()">üì∑<br>–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
        <p style="margin-top:20px; color:#888;">–†–µ–∂–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª–∞</p>
    </div>

    <div id="client-screen">
        <h2 id="username">–ì–æ—Å—Ç—å</h2>
        <div>–í–∞—à–∏ –±–∞–ª–ª—ã:</div>
        <div class="balance" id="balance">0</div>
        <div id="qrcode"></div>
        <div id="timer" style="color:#888; font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div id="debug-info">ID: ...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const SECRET_KEY = "MY_SUPER_SECRET_KEY";
        const STAFF_IDS = [ 627287121 ]; // –¢–≤–æ–π ID

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const user = tg.initDataUnsafe.user;
        const urlParams = new URLSearchParams(window.location.search);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞)
        const currentId = user ? user.id : "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
        document.getElementById('debug-info').innerText = "–ú–æ–π ID: " + currentId;

        // --- –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ---
        if (user && STAFF_IDS.includes(user.id)) {
            // –≠–¢–û –ö–ê–°–°–ò–†
            document.getElementById('staff-screen').style.display = 'block';
        } else {
            // –≠–¢–û –ö–õ–ò–ï–ù–¢ (–∏–ª–∏ ID –Ω–µ —Å–æ–≤–ø–∞–ª)
            showClientScreen();
        }

        // --- –§–£–ù–ö–¶–ò–ò ---
        function openScanner() {
            tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞' }, (data) => {
                tg.closeScanQrPopup();
                tg.sendData(data);
            });
        }

        function showClientScreen() {
            document.getElementById('client-screen').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –∏ –±–∞–ª–∞–Ω—Å
            if (user) document.getElementById('username').innerText = user.first_name;
            const bal = urlParams.get('balance');
            if(bal) document.getElementById('balance').innerText = bal;

            // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR
            generateQR();
            setInterval(generateQR, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
            
            // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
            let timeLeft = 30;
            setInterval(() => {
                timeLeft--;
                if(timeLeft < 0) timeLeft = 30;
                document.getElementById('timer').innerText = –ö–æ–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ ${timeLeft} —Å–µ–∫;
            }, 1000);
        }

        function generateQR() {
            const userId = user ? user.id.toString() : "DEMO";
            const timestamp = Math.floor(Date.now() / 1000);
            
            // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ crypto-js –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª—Å—è
            let hash = "no-crypto";
            if (typeof CryptoJS !== 'undefined') {
                hash = CryptoJS.HmacSHA256(userId + timestamp, SECRET_KEY).toString(CryptoJS.enc.Hex);
            }

            const qrData = JSON.stringify({ u: userId, t: timestamp, s: hash.substring(0, 10) });

            // –û—á–∏—â–∞–µ–º –∏ —Ä–∏—Å—É–µ–º –∑–∞–Ω–æ–≤–æ
            const qrDiv = document.getElementById("qrcode");
            qrDiv.innerHTML = "";
            new QRCode(qrDiv, {
                text: qrData,
                width: 180,
                height: 180,
                correctLevel: QRCode.CorrectLevel.L // –õ–µ–≥–∫–∏–π —É—Ä–æ–≤–µ–Ω—å (–±—ã—Å—Ç—Ä–µ–µ —Ä–∏—Å—É–µ—Ç—Å—è)
            });
        }
    </script>
</body>
</html>